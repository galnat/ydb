# Manage {{ ydb-short-name }} releases

На базе исходного кода из [репозитория {{ ydb-short-name }}](https://github.com/ydb-platform/ydb) разрабатываются два продукта с независимыми релизными циклами:

- [Сервер {{ ydb-short-name }}](#server)
- [Интерфейс командной строки {{ ydb-short-name }} (CLI)](#cli)

## Релизный цикл сервера {{ ydb-short-name }} {#server}

Данный документ описывает релизный цикл, начиная с мажорного релиза 25.1.

Если у вас возникли вопросы по этому документу, обращайтесь к [команде {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/engineering).

### Номера и расписание релизов {#server-versioning}

Версия сервера {{ ydb-short-name }} состоит из четырех чисел, разделенных точками:

1. Две последние цифры календарного года релиза
2. Порядковый номер мажорного релиза в текущем году
3. Порядковый номер минорного релиза в этом мажорном релизе
4. Порядковый номер патча (релизного тега) в минорном релизе

Таким образом:

* Мажорная версия - это комбинация первых двух чисел (например, `25.1`)
* Минорная версия - это комбинация первых трёх чисел (например, `25.1.2`)
* Полная версия - это комбинация всех четырёх чисел (например, `23.1.2.1`).

В течение года обычно выпускается 4 мажорных релиза сервера {{ ydb-short-name }}: `YY.1` – первый, а `YY.4` - последний в году `YY`. Количество минорных релизов и патчей не является постоянным и может варьироваться от одного мажорного релиза к другому.

### Совместимость {#server-compatibility}

Совместимость версий {{ ydb-short-name }} - это гарантии, что кластер сможет работать, даже если на его узлах выполняются две смежные мажорные версии исполняемого файла сервера {{ ydb-short-name }}. Подробнее о процедуре обновления кластера вы можете прочитать в статье [Обновление {{ ydb-short-name }}](../devops/manual/upgrade.md).

Для обеспечения такой совместимости мажорные релизы выпускаются парами:

* В нечетных версиях добавляется новая функциональность, отключенная с помощью feature-флагов
* В четных версиях эта функциональность включается по-умолчанию

Например, версия `25.1` поставляется с отключенной новой функциональностью, и может быть постепенно развернута на кластере, работающем под управлением `24.4`, без остановки работы кластера. Как только на всех узлах кластера будет запущена `25.1`, его можно будет далее обновить до `25.2`, чтобы использовать новые функциональные возможности.

### Релизные ветки и теги {#server-branches-tags}

#### Виды коммитов {#commit_types}

* **Фича**. К фичам относятся любые добавляющие новую функциональность изменения, не связанные с исправлением ошибок.
* **Исправление ошибки**. Изменение, направленное на устранение конкретной ошибки.
* **Исправление критической ошибки**. Срочное исправление серьезной проблемы, которое требуется немедленно выкатить в продакшн. Без срочного исправления критических ошибок высока вероятность наступления серьезных негативных последствий.

#### Типы релизных веток {#release_branch_types}

* **Мажорная ветка** - ветка, в которой хранится исходный код соответствующей мажорной версии. Именуются `stable-XX-Y` (например, `stable-24-1` или `stable-25-1`). В эту ветку можно мерджить новые фичи согласно [инструкции](#merge-feature) и исправления ошибок по [инструкции](#merge-bugfix).
  
* **Минорная ветка** - ветка, в которой создаются релизные теги, которые раскатываются на кластера. Именуется `stable-XX-Y-Z` (например, `stable-25-1-2`). Релизные теги имеют формат `XX.Y.Z.A`. Минорная ветка отводится только от мажорной ветки после успешной выкатки предыдущей минорной ветки. В минорную ветку можно мерджить только исправления ошибок, следуя [инструкции](#merge-bugfix).

* **Хотфиксная ветка** - ветка для срочного исправления критических ошибок в конкретном релизном теге. Именуется `stable-XX-Y-Z-A-hotfix` (где `XX.Y.Z.A` - имя релизного тега), например, `stable-24-1-1-2-hotfix`. Такие ветки отводятся только от релизных тегов из минорных веток при необходимости сделать хотфикс. В хотфиксные ветки можно мержить только исправления критических ошибок, которые требуется немедленно выкатить в продакшн.

#### Общая схема работы с ветками {#release_branch_scheme}

![release_branches](_assets/release_branch.svg)

Цикл выпуска для нечетного мажорного релиза начинается с отведения от `main` ветки участником [команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/engineering). Название релизной ветки начинается с префикса `stable-`, за которым следует мажорная версия с точками, замененными на дефис (например, `stable-23-1`).

Цикл выпуска четного мажорного релиза начинается с отведения ветки от ветки предыдущего нечетного мажорного релиза.

От мажорной ветки отводится минорная ветка. Все выпуски минорных версий для нечетных и четных мажорных релизов, проходят цикл тестирования, в процессе которого создается ряд патчей. Каждый патч фиксируется путем назначения тега с полным номером версии на соответствующей релизной ветке. Таким образом, в минорной ветке `stable-24-1-1` могут быть теги `24.1.1.1`, `24.1.1.2` и т.д. Как только тег успешно прошел необходимое тестирование, мы считаем его стабильным, и регистрируем релиз на GitHub для этого тега, добавляем его на страницы документации [загрузки](../downloads/index.md#ydb-server) и в [список изменений](../changelog-server.md), и так далее. Для мажорной версии может быть более одного стабильного релиза.

### Мердж исправления ошибки в релизные ветки {#merge-bugfix}

Для исправлений, которые нужно внедрить в релиз:

1. Замерджите исправление в ветку `main` и все активные мажорные ветки. Такое исправление попадет в следующий минорный релиз.

Для исправлений, которые нужно внедрить быстрее (в течение 1-2 недель):

1. Замерджите исправление в ветку `main` и все активные мажорные ветки.
2. Согласуйте мердж исправления в активные минорные ветки с [команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/engineering) на внутренней встрече.
3. После согласования замерджите исправления во все активные минорные ветки.

Информацию о текущих активные мажорных и минорных ветках можно найти у [команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/engineering) или в закрепленном сообщении чата YDB Releases, если вы являетесь участником команды.

### Мерж исправления критической ошибки в релизные ветки {#merge-hotfix}

Для исправления критических ошибок:

1. Определите версию базы (соответствует номеру релизного тега), на которой возникла проблема.
2. Найдите подходящую хотфиксную ветку в формате `stable-XX-Y-Z-A-hotfix`.
3. Добавьте исправления во все необходимые ветки: main, хотфиксную ветку, а также все активные мажорные и минорные ветки.

Если ошибка обнаружена не на конкретном релизном теге, добавьте исправление в main, активную хотфиксную ветку и все активные мажорные и минорные ветки.

Информацию о текущих активных мажорных, минорных и хотфиксных ветках можно найти у [команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/engineering) или в закрепленном сообщении чата YDB Releases, если вы являетесь участником команды.

### Мерж фичи в релизные ветки {#merge-feature}

Чтобы замерджить фичу в мажорную ветку (например, `stable-25-1`) после ее отведения:

1. Согласуйте добавление фичи в релиз со своим руководителем.

2. Внесите информацию о фиче в релизную таблицу (выберите актуальный релиз) - заполните все поля.

3. Создайте Pull Request в мажорную ветку, указав в секции `Description for reviewers` причину добавления фичи в текущий релиз. Все тесты в Pull Request должны быть успешно пройдены.

В минорные ветки, начиная с `stable-XX-Y-2`, добавляется не более трех новых фич (не считая переключения флагов). Это означает, что фича может не попасть в ближайший релизный тег. Это ограничение введено, чтобы сократить время на отладку релизных тегов.

### Тестирование {#server-testing}

Каждая минорная версия проходит приемочное тестирование. После чего код из минорной ветки проходит комплексную проверку, включая развертывание во внутренних кластерах - testing, prestable, и production. 

{% include [corp_release_testing.md](_includes/corp_release_testing.md) %}

Основываясь на выявленных проблемах, [релизная команда {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/release) решает, можно ли повысить статус минорного релиза до стабильного, или необходимо запустить новую итерацию тестирования с новым тегом минорного релиза. Фактически, как только во время тестирования обнаруживается критическая проблема, разработчики исправляют ее в `main` и сразу же мержат изменения в релизную ветку. Таким образом, к моменту завершения тестирования, если в релизной ветке есть какие-либо коммиты поверх текущего тега, это означает что последует новый тег и новая итерация тестирования.

### Стабильный релиз {#server-stable}

Если итерация тестирования подтверждает качество минорного релиза, [релизная команда {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/release) готовит [перечень изменений](../changelog-server.md), и публикует релиз на страницах [Releases](https://github.com/ydb-platform/ydb/releases) на GitHub и [Загрузки](../downloads/index.md#ydb-server) в документации, объявляя его тем самым стабильным.

После этого от мажорной ветки отводится следующуя минорная ветка и проходит аналогичный цикл стабилизации.

{% include [corp_release_stable.md](_includes/corp_release_stable.md) %}

## Цикл выпуска {{ ydb-short-name }} CLI (интерфейс командной строки) {#cli}

### Номера выпусков и расписание {#cli-versioning}

Версия {{ ydb-short-name }} CLI состоит из трех чисел, разделенных точкой:

1. Порядковый номер мажорного релиза (в настоящее время "2")
2. Порядковый номер минорного релиза в этом мажорном релизе
3. Порядковый номер патча (релизного тега) в минорном релизе

Например, версия `2.8.0` обозначате вторую мажорную, восьмую минорную версию, без патчей.

В отличие от сервера {{ ydb-short-name }}, для CLI не существует фиксированного расписания выпуска релизов. Новые минорные версии публикуются по мере готовности значимых улучшений или новой функциональности. При первоначальном выпуске минорной версии номер патча равен 0. Если в этой версии обнаруживаются критические ошибки, или в неё не вошла какая-то незначительная часть запланированной функциональности, мы можем выпустить патч, увеличив только номер патча, как это было для `2.1.1`.

Процесс выпуска {{ ydb-short-name }} CLI значительно упрощен по сравнению с сервером {{ ydb-short-name }}, что позволяет выпускать релизы чаще.

### Релизные теги {#cli-tags}

Теги для {{ ydb-short-name }} CLI назначаются в транке (ветка `main`) участником [релизной команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/release) после запуска тестов для некоторой ревизии. Чтобы отличаться от тегов сервера {{ ydb-short-name }}, теги CLI {{ ydb-short-name }} содержат префикс `CLI_` перед номером версии, например [CLI_2.8.0](https://github.com/ydb-platform/ydb/tree/CLI_2.8.0).

{% include [corp_cli_tags.md](_includes/corp_cli_tags.md) %}

### Стабильный релиз {#cli-stable}

Чтобы объявить тег {{ ydb-short-name }} CLI стабильным, участник [релизной команды {{ ydb-short-name }}](https://github.com/orgs/ydb-platform/teams/release) готовит [перечень изменений](../changelog-cli.md), и публикует релиз на странице GitHub [Releases](https://github.com/ydb-platform/ydb/releases) и в разделе [Загрузки](../downloads/index.md#ydb-cli) документации.
